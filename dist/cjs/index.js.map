{"version":3,"file":"index.js","sources":["../../src/defaults.js","../../src/domUtils.js","../../src/createContextHistory.js","../../src/createObservableContext.js","../../src/observeElDimensions.js","../../src/setCanvasHTMLElementDimensions.js","../../src/transformContextMatrix.js","../../src/restoreFromHistory.js","../../src/index.js"],"sourcesContent":["export default {\n  target: document.body,\n  viewBox: [0, 0, 300, 150],\n  autoAspectRatio: true,\n  scaleMode: 'fit',\n  resolution: 1,\n  preserveHistory: false,\n};\n","function resolveTarget(target) {\n  if (typeof target === 'string') {\n    return document.querySelector(target);\n  } else {\n    return target;\n  }\n}\n\nfunction createCanvasHTMLElement() {\n  const el = document.createElement('canvas');\n\n  return el;\n}\n\nfunction getCanvasContext(canvasHTMLElement) {\n  return canvasHTMLElement.getContext('2d');\n}\n\nfunction mountCanvasToDOM(target, el) {\n  target.appendChild(el);\n}\n\nexport {\n  resolveTarget,\n  createCanvasHTMLElement,\n  getCanvasContext,\n  mountCanvasToDOM,\n};\n","function createContextHistory() {\n  const store = new Map();\n  let position = 0;\n\n  return {\n    get entries() {\n      return store.values();\n    },\n    get size() {\n      return store.size;\n    },\n    push(type, name, args) {\n      store.set(position, { type, name, args });\n\n      position++;\n    },\n    clear() {\n      store.clear();\n    },\n  };\n}\n\nexport { createContextHistory };\n","function createObservableContext(baseContext, observe) {\n  return new Proxy(baseContext, {\n    get(target, name) {\n      if (typeof target[name] === 'function') {\n        return function () {\n          target[name].apply(target, arguments);\n\n          observe('function', name, [...arguments]);\n        };\n      } else {\n        return target[name];\n      }\n    },\n    set(target, name, val) {\n      target[name] = val;\n\n      observe('set', name, val);\n\n      // succesful operation âœ…\n      return true;\n    },\n  });\n}\n\nexport { createObservableContext };\n","import ResizeObserver from 'resize-observer-polyfill';\nimport { debounce } from 'lodash-es';\n\nfunction observeElDimensions(el, callback) {\n  let { width: prevWidth, height: prevHeight } = el.getBoundingClientRect();\n\n  const resizeObserver = new ResizeObserver(\n    debounce(([entry]) => {\n      const { width, height } = entry.contentRect;\n\n      // prevent infinite resize loops if canvas CSS dimensions are not explicitely set\n\n      if (width !== prevWidth || height !== prevHeight) {\n        callback(entry);\n\n        prevWidth = width;\n        prevHeight = height;\n      }\n    }, 500)\n  );\n\n  resizeObserver.observe(el);\n}\n\nexport { observeElDimensions };\n","function calculateHeightFromAspectRatio(el, viewBox) {\n  const width = el.getBoundingClientRect().width;\n  const aspectRatioPercentage = viewBox[3] / viewBox[2];\n\n  return width * aspectRatioPercentage + 'px';\n}\n\nfunction setCanvasHTMLElementDimensions({\n  el,\n  autoAspectRatio,\n  viewBox,\n  resolution,\n}) {\n  if (autoAspectRatio) {\n    el.style.height = calculateHeightFromAspectRatio(el, viewBox);\n  }\n\n  const { width, height } = el.getBoundingClientRect();\n\n  el.width = width * resolution;\n  el.height = height * resolution;\n}\n\nexport { setCanvasHTMLElementDimensions };\n","function calculateAspectRatio(\n  srcWidth,\n  srcHeight,\n  maxWidth,\n  maxHeight,\n  scaleMode\n) {\n  let ratio;\n\n  if (scaleMode === 'fit') {\n    ratio = Math.min(maxWidth / srcWidth, maxHeight / srcHeight);\n  } else {\n    ratio = Math.max(maxWidth / srcWidth, maxHeight / srcHeight);\n  }\n\n  return { fitWidth: srcWidth * ratio, fitHeight: srcHeight * ratio };\n}\n\nfunction clipCtx(ctx, viewBoxWidth, viewBoxHeight) {\n  ctx.beginPath(viewBoxWidth, viewBoxHeight);\n  ctx.rect(0, 0, viewBoxWidth, viewBoxHeight);\n  ctx.clip();\n  ctx.closePath();\n}\n\nfunction transformContextMatrix({ ctx, viewBox, resolution, scaleMode }) {\n  const viewBoxWidth = viewBox[2];\n  const viewBoxHeight = viewBox[3];\n\n  let {\n    width: canvasWidth,\n    height: canvasHeight,\n  } = ctx.canvas.getBoundingClientRect();\n\n  canvasWidth *= resolution;\n  canvasHeight *= resolution;\n\n  const { fitWidth, fitHeight } = calculateAspectRatio(\n    viewBoxWidth,\n    viewBoxHeight,\n    canvasWidth,\n    canvasHeight,\n    scaleMode\n  );\n\n  const scaleX = fitWidth / viewBoxWidth;\n  const scaleY = fitHeight / viewBoxHeight;\n\n  const translateX = (canvasWidth - fitWidth) / 2;\n  const translateY = (canvasHeight - fitHeight) / 2;\n\n  ctx.setTransform(scaleX, 0, 0, scaleY, translateX, translateY);\n\n  clipCtx(ctx, viewBoxWidth, viewBoxHeight);\n}\n\nexport { transformContextMatrix };\n","function restoreFromHistory(ctx, history) {\n  for (const entry of history.entries) {\n    if (entry.type === 'function') {\n      ctx[entry.name].apply(ctx, entry.args);\n    } else {\n      ctx[entry.name] = entry.args;\n    }\n  }\n}\n\nexport { restoreFromHistory };\n","import DEFAULTS from './defaults';\n\nimport {\n  resolveTarget,\n  createCanvasHTMLElement,\n  getCanvasContext,\n  mountCanvasToDOM,\n} from './domUtils';\n\nimport { createContextHistory } from './createContextHistory';\nimport { createObservableContext } from './createObservableContext';\nimport { observeElDimensions } from './observeElDimensions';\nimport { setCanvasHTMLElementDimensions } from './setCanvasHTMLElementDimensions';\nimport { transformContextMatrix } from './transformContextMatrix';\nimport { restoreFromHistory } from './restoreFromHistory';\n\nfunction createCanvas(opts) {\n  opts = Object.assign(DEFAULTS, opts);\n  opts.target = resolveTarget(opts.target);\n\n  var style = document.createElement('style');\n  style.innerHTML = `\n    canvas {\n      width: 100%;\n    }\n  `;\n  document.head.appendChild(style);\n\n  const history = createContextHistory();\n\n  const canvasHTMLElement = createCanvasHTMLElement();\n\n  const baseContext = getCanvasContext(canvasHTMLElement);\n  const observableContext = createObservableContext(\n    baseContext,\n    (type, name, args) => {\n      history.push(type, name, args);\n    }\n  );\n\n  function resizeCanvas() {\n    setCanvasHTMLElementDimensions({\n      el: canvasHTMLElement,\n      autoAspectRatio: opts.autoAspectRatio,\n      viewBox: opts.viewBox,\n      resolution: opts.resolution,\n    });\n\n    transformContextMatrix({\n      ctx: baseContext,\n      viewBox: opts.viewBox,\n      resolution: opts.resolution,\n      scaleMode: opts.scaleMode,\n    });\n\n    if (opts.preserveHistory) {\n      restoreFromHistory(baseContext, history);\n    }\n  }\n\n  mountCanvasToDOM(opts.target, canvasHTMLElement);\n\n  resizeCanvas();\n\n  observeElDimensions(canvasHTMLElement, resizeCanvas);\n\n  return {\n    el: canvasHTMLElement,\n    ctx: opts.preserveHistory ? observableContext : baseContext,\n  };\n}\n\nexport { createCanvas };\n"],"names":["ResizeObserver","debounce"],"mappings":"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"}